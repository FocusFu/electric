C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 1   


C51 COMPILER V9.54, COMPILATION OF MODULE ULTRASONIC
OBJECT MODULE PLACED IN UltraSonic.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE UltraSonic.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /**********************************°üº¬Í·ÎÄ¼ş**********************************/
   2          #include <reg52.h>
   3          #include "1602.h"
   4          #include<intrins.h> 
   5          /************************************ºê¶¨Òå************************************/
   6          #define uchar unsigned char
   7          #define uint unsigned int
   8          #define VELOCITY_30C  3495       //30ÉãÊÏ¶ÈÊ±µÄÉùËÙ£¬ÉùËÙV= 331.5 + 0.6*ÎÂ¶È£» 
   9          //#define VELOCITY_23C  3453       //23ÉãÊÏ¶ÈÊ±µÄÉùËÙ£¬ÉùËÙV= 331.5 + 0.6*ÎÂ¶È£» 
  10          #define BASIC 3315
  11          #define lambda 6
  12          /************************************Î»¶¨Òå************************************/
  13          sbit INPUT  = P3^2;                //»ØÉù½ÓÊÕ¶Ë¿Ú
  14          sbit OUTPUT = P1^5;                //³¬Éù´¥·¢¶Ë¿Ú
  15          sbit Beep   = P2^3;                // ·äÃùÆ÷
  16          sbit DS     = P2^2;                //define interface
  17          sbit E=P2^5;            //Ê¹ÄÜĞÅºÅÎ»£¬½«EÎ»¶¨ÒåÎªP2.5Òı½Å
  18          sbit BF=P0^7;           //Ã¦Âµ±êÖ¾Î»£¬£¬½«BFÎ»¶¨ÒåÎªP0.7Òı½Å
  19          /********************************¶¨Òå±äÁ¿ºÍÊı×é********************************/
  20          long int distance=0;               //¾àÀë±äÁ¿
  21          uchar table[]="  Designed by  "; 
  22          uchar table0[]="WeiLu and YuYaojia";
  23          uchar table1[]="There's no echo.";
  24          uchar table2[]="  www.hjmcu.com  ";
  25          uchar table3[]="Distance:";
  26          unsigned char code digit[10]={"0123456789"};     //¶¨Òå×Ö·ûÊı×éÏÔÊ¾Êı×Ö
  27          unsigned char code Str[]={"Test by DS18B20"};    //ËµÃ÷ÏÔÊ¾µÄÊÇÎÂ¶È
  28          unsigned char code Error[]={"Error!Check!"};     //ËµÃ÷Ã»ÓĞ¼ì²âµ½DS18B20
  29          unsigned char code Temp[]={"Temp:"};             //ËµÃ÷ÏÔÊ¾µÄÊÇÎÂ¶È
  30          unsigned char code Cent[]={"Cent"};              //ÎÂ¶Èµ¥Î»
  31          uchar count;
  32          /***********************************º¯ÊıÉùÃ÷***********************************/
  33          extern void initLCD();
  34          extern void write_date(uchar date);
  35          extern void write_com(uchar com);
  36          extern void delay(uint x);
  37          long int VELOCITY;       //23ÉãÊÏ¶ÈÊ±µÄÉùËÙ£¬ÉùËÙV= 331.5 + 0.6*ÎÂ¶È£»
  38          /******************************************************************************/
  39          /* º¯ÊıÃû³Æ  : Delay_xMs                                                      */
  40          /* º¯ÊıÃèÊö  : ÑÓÊ±º¯Êı                                                       */
  41          /* ÊäÈë²ÎÊı  : x                                                              */
  42          /* ²ÎÊıÃèÊö  : ÑÓÊ±Ê±¼ä                                                       */
  43          /* ·µ»ØÖµ    : ÎŞ                                                             */
  44          /******************************************************************************/
  45          void Delay_xMs(unsigned int x)
  46          {
  47   1        unsigned int i,j;
  48   1        for(i = 0;i < x;i++ )
  49   1        {
  50   2          for(j = 0;j < 3;j++ )
  51   2          {
  52   3               ;
  53   3          }
  54   2        }
  55   1      }
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 2   

  56          /******************************************************************************/
  57          /* º¯ÊıÃû³Æ  : Alarm                                                          */
  58          /* º¯ÊıÃèÊö  : ·äÃùÆ÷·¢Éùº¯Êı                                                 */
  59          /* ÊäÈë²ÎÊı  : t                                                              */
  60          /* ²ÎÊıÃèÊö  : ·¢ÉùµÄ´ÆµÂÊ                                                     */
  61          /* ·µ»ØÖµ    : ÎŞ                                                             */
  62          /******************************************************************************/
  63          void Alarm(uchar t)
  64          {
  65   1        uchar i;
  66   1        for(i = 0;i < t;i++)
  67   1        {
  68   2          Beep = 0;
  69   2          Delay_xMs(1000/t);
  70   2          Beep = 1;
  71   2          Delay_xMs(1000/t);
  72   2        }
  73   1      } 
  74          /******************************************************************************/
  75          /* º¯ÊıÃû³Æ  : delayt                                                         */
  76          /* º¯ÊıÃèÊö  : ÑÓÊ±º¯Êı                                                       */
  77          /* ÊäÈë²ÎÊı  : x                                                              */
  78          /* ²ÎÊıÃèÊö  : ÑÓÊ±Ê±¼äÊı¾İ                                                   */
  79          /* ·µ»ØÖµ    : ÎŞ                                                             */
  80          /******************************************************************************/  
  81          void delayt(uint x)
  82          {
  83   1        uchar j;
  84   1        while(x-- > 0)
  85   1          {
  86   2            for(j = 0;j < 125;j++)
  87   2            {
  88   3                  ;
  89   3            }
  90   2          }
  91   1      }
  92          /******************************************************************************/
  93          /* º¯ÊıÃû³Æ  : Init_MCU                                                       */
  94          /* º¯ÊıÃèÊö  : ³õÊ¼»¯µ¥Æ¬»úº¯Êı                                               */
  95          /* ÊäÈë²ÎÊı  : ÎŞ                                                             */
  96          /* ²ÎÊıÃèÊö  : ÎŞ                                                             */
  97          /* ·µ»ØÖµ    : ÎŞ                                                             */
  98          /******************************************************************************/
  99          void Init_MCU(void)
 100          {
 101   1        TMOD = 0x01;    //¶¨Ê±Æ÷2³õÊ¼»¯,ÉèÖÃÎª16Î»×Ô¶¯ÖØ×°Ä£Ê½
 102   1        TL0 = 0x66;
 103   1        TH0 = 0xfc;     //1ms
 104   1        ET0 = 1;        //¿ª¶¨Ê±Æ÷2
 105   1        EA = 1;         //×ÜÖĞ¶ÏÊ¹ÄÜ
 106   1      }
 107          /******************************************************************************/
 108          /* º¯ÊıÃû³Æ  : Init_Parameter                                                 */
 109          /* º¯ÊıÃèÊö  : ³õÊ¼»¯²ÎÊıºÍIO¿Úº¯Êı                                           */
 110          /* ÊäÈë²ÎÊı  : ÎŞ                                                             */
 111          /* ²ÎÊıÃèÊö  : ÎŞ                                                             */
 112          /* ·µ»ØÖµ    : ÎŞ                                                             */
 113          /******************************************************************************/
 114          void Init_Parameter(void)
 115          {
 116   1         OUTPUT =0;//³¬ÉùÊä³ö¹Ø±Õ
 117   1         INPUT = 0;//³¬ÉùÊäÈë¹Ø±Õ
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 3   

 118   1         count = 0;
 119   1         distance = 0;
 120   1      }
 121          /******************************************************************************/
 122          /* º¯ÊıÃû³Æ  : display_char                                                   */
 123          /* º¯ÊıÃèÊö  : ÏÔÊ¾×Ö·û´®º¯Êı                                                 */
 124          /* ÊäÈë²ÎÊı  : point,address                                                  */
 125          /* ²ÎÊıÃèÊö  : Ğ´ÈëµÄ×Ö·û´®µÄµØÖ·Ö¸Õë 1602ÏÔÊ¾¶ÔÓ¦µÄµØÖ·                      */
 126          /* ·µ»ØÖµ    : ÎŞ                                                             */
 127          /******************************************************************************/
 128          void display_char(uchar *point,uchar address)
 129          {
 130   1        uchar i;
 131   1        write_com(0x80 + address);
 132   1        for(i = 0;i < 16; i++)
 133   1        {
 134   2          write_date(*point);
 135   2          point++;
 136   2        }
 137   1      }
 138          /******************************************************************************/
 139          /* º¯ÊıÃû³Æ  : display                                                        */
 140          /* º¯ÊıÃèÊö  : ÏÔÊ¾Êı×Ö                                                       */
 141          /* ÊäÈë²ÎÊı  : number£¬address                                                */
 142          /* ²ÎÊıÃèÊö  : numberĞ´ÈëµÄÊı¾İ£¬addressµØÖ·                                  */
 143          /* ·µ»ØÖµ    : ÎŞ                                                             */
 144          /******************************************************************************/  
 145          void display(int number,uchar address)
 146          {
 147   1        uchar b,c,d,e;
 148   1        b= (number / 1000);
 149   1        c= (number / 100) % 10;
 150   1        d = (number / 10) % 10;
 151   1        e = number % 10;
 152   1        write_com(0x80 + address);
 153   1        write_date(b + 48);
 154   1        write_date(c + 48);
 155   1        write_date(d + 48);
 156   1        write_date(46);           //Ğ¡ÊıµãµÄASCII
 157   1        write_date(e + 48);
 158   1        write_date(99);           //"c"µÄASCII
 159   1        write_date(109);          //"m"µÄASCII
 160   1      }
 161          /******************************************************************************/
 162          /* º¯ÊıÃû³Æ  : Trig_SuperSonic                                                */
 163          /* º¯ÊıÃèÊö  : ·¢³öÉù²¨º¯Êı                                                   */
 164          /* ÊäÈë²ÎÊı  : i                                                              */
 165          /* ²ÎÊıÃèÊö  : ·¢³öµÄÂö³å´ÎÊı                                                 */
 166          /* ·µ»ØÖµ    : ÎŞ                                                             */
 167          /******************************************************************************/
 168          void Trig_SuperSonic(int i)//³ö·¢Éù²¨40kHz
 169          {
 170   1        int j;
 171   1        for(j=0;j<i;j++)
 172   1        {
 173   2          _nop_();
 174   2          _nop_();
 175   2          _nop_();
 176   2          _nop_();
 177   2          _nop_();
 178   2          _nop_();
 179   2          _nop_();
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 4   

 180   2          _nop_();
 181   2          _nop_();
 182   2          _nop_();
 183   2          OUTPUT = 1;
 184   2          _nop_();
 185   2          _nop_();
 186   2          _nop_();
 187   2          _nop_();
 188   2          _nop_();
 189   2          _nop_();
 190   2          _nop_();
 191   2          _nop_();
 192   2          _nop_();
 193   2          OUTPUT = 0;
 194   2        }
 195   1      }
 196          /******************************************************************************/
 197          /* º¯ÊıÃû³Æ  : Measure_Distance                                               */
 198          /* º¯ÊıÃèÊö  : ¼ÆËã¾àÀëº¯Êı                                                   */
 199          /* ÊäÈë²ÎÊı  : ÎŞ                                                             */
 200          /* ²ÎÊıÃèÊö  : ÎŞ                                                             */
 201          /* ·µ»ØÖµ    : 0ÊÇ³¬Ê±Ã»ÊÕµ½£¬1ÊÇÊÕµ½ÁË                                       */
 202          /******************************************************************************/
 203          int Measure_Distance(void)
 204          {
 205   1        uchar l;
 206   1        uint h,y;
 207   1        TR0 = 1;
 208   1        while(INPUT==0)
 209   1          {
 210   2            if(count==18)
 211   2              {   
 212   3                TR0 =0;
 213   3                TL0 = 0x66;
 214   3                TH0 = 0xfc;
 215   3                count = 0;
 216   3              }
 217   2              return 0;
 218   2          } 
 219   1        TR0 = 0;
 220   1        l = TL0;
 221   1        h = TH0;
 222   1        y = (h << 8) + l;
 223   1        y = y - 0xfc66;//us²¿·Ö
 224   1        distance = y + 1000 * count;//¼ÆËã×ÜÊ±¼ä
 225   1        TL0 = 0x66;
 226   1        TH0 = 0xfc;
 227   1        delayt(30);
 228   1        distance = VELOCITY * distance / 20000;
 229   1        return 1;
 230   1      }
 231          /*****************************************************
 232          º¯Êı¹¦ÄÜ£ºÅĞ¶ÏÒº¾§Ä£¿éµÄÃ¦Âµ×´Ì¬
 233          ·µ»ØÖµ£ºresult¡£result=1£¬Ã¦Âµ;result=0£¬²»Ã¦
 234          ***************************************************/
 235          bit BusyTest(void)
 236          {
 237   1        bit result;
 238   1        RS=0;       //¸ù¾İ¹æ¶¨£¬RSÎªµÍµçÆ½£¬RWÎª¸ßµçÆ½Ê±£¬¿ÉÒÔ¶Á×´Ì¬
 239   1        RW=1;
 240   1        E=1;        //E=1£¬²ÅÔÊĞí¶ÁĞ´
 241   1        _nop_();   //¿Õ²Ù×÷
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 5   

 242   1        _nop_();
 243   1        _nop_(); 
 244   1        _nop_();   //¿Õ²Ù×÷ËÄ¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä 
 245   1        result=BF;  //½«Ã¦Âµ±êÖ¾µçÆ½¸³¸øresult
 246   1        E=0;         //½«E»Ö¸´µÍµçÆ½
 247   1        return result;
 248   1      }
 249          /*****************************************************
 250          º¯Êı¹¦ÄÜ£º½«Ä£Ê½ÉèÖÃÖ¸Áî»òÏÔÊ¾µØÖ·Ğ´ÈëÒº¾§Ä£¿é
 251          Èë¿Ú²ÎÊı£ºdictate
 252          ***************************************************/
 253          void WriteInstruction (unsigned char dictate)
 254          {
 255   1        while(BusyTest()==1);   //Èç¹ûÃ¦¾ÍµÈ´ı
 256   1        RS=0;                  //¸ù¾İ¹æ¶¨£¬RSºÍR/WÍ¬Ê±ÎªµÍµçÆ½Ê±£¬¿ÉÒÔĞ´ÈëÖ¸Áî
 257   1        RW=0;   
 258   1        E=0;                   //EÖÃµÍµçÆ½(¸ù¾İ±í8-6£¬Ğ´Ö¸ÁîÊ±£¬EÎª¸ßÂö³å£¬
 259   1                                 // ¾ÍÊÇÈÃE´Ó0µ½1·¢ÉúÕıÌø±ä£¬ËùÒÔÓ¦ÏÈÖÃ"0"
 260   1        _nop_();
 261   1        _nop_();               //¿Õ²Ù×÷Á½¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä
 262   1        P0=dictate;            //½«Êı¾İËÍÈëP0¿Ú£¬¼´Ğ´ÈëÖ¸Áî»òµØÖ·
 263   1        _nop_();
 264   1        _nop_();
 265   1        _nop_();
 266   1        _nop_();               //¿Õ²Ù×÷ËÄ¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä
 267   1        E=1;                   //EÖÃ¸ßµçÆ½
 268   1        _nop_();
 269   1        _nop_();
 270   1        _nop_();
 271   1        _nop_();               //¿Õ²Ù×÷ËÄ¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä
 272   1        E=0;                  //µ±EÓÉ¸ßµçÆ½Ìø±ä³ÉµÍµçÆ½Ê±£¬Òº¾§Ä£¿é¿ªÊ¼Ö´ĞĞÃüÁî
 273   1       }
 274          /*****************************************************
 275          º¯Êı¹¦ÄÜ£ºÖ¸¶¨×Ö·ûÏÔÊ¾µÄÊµ¼ÊµØÖ·
 276          Èë¿Ú²ÎÊı£ºx
 277          ***************************************************/
 278          void WriteAddress(unsigned char x)
 279          {
 280   1        WriteInstruction(x|0x80); //ÏÔÊ¾Î»ÖÃµÄÈ·¶¨·½·¨¹æ¶¨Îª"80H+µØÖ·Âëx"
 281   1      }
 282          /*****************************************************
 283          º¯Êı¹¦ÄÜ£º½«Êı¾İ(×Ö·ûµÄ±ê×¼ASCIIÂë)Ğ´ÈëÒº¾§Ä£¿é
 284          Èë¿Ú²ÎÊı£ºy(Îª×Ö·û³£Á¿)
 285          ***************************************************/
 286          void WriteData(unsigned char y)
 287          {
 288   1        while(BusyTest()==1);  
 289   1        RS=1;           //RSÎª¸ßµçÆ½£¬RWÎªµÍµçÆ½Ê±£¬¿ÉÒÔĞ´ÈëÊı¾İ
 290   1        RW=0;
 291   1        E=0;            //EÖÃµÍµçÆ½(¸ù¾İ±í8-6£¬Ğ´Ö¸ÁîÊ±£¬EÎª¸ßÂö³å£¬
 292   1                           // ¾ÍÊÇÈÃE´Ó0µ½1·¢ÉúÕıÌø±ä£¬ËùÒÔÓ¦ÏÈÖÃ"0"
 293   1        P0=y;           //½«Êı¾İËÍÈëP0¿Ú£¬¼´½«Êı¾İĞ´ÈëÒº¾§Ä£¿é
 294   1        _nop_();
 295   1        _nop_();
 296   1        _nop_();
 297   1        _nop_();       //¿Õ²Ù×÷ËÄ¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä
 298   1        E=1;           //EÖÃ¸ßµçÆ½
 299   1        _nop_();
 300   1        _nop_();
 301   1        _nop_();
 302   1        _nop_();        //¿Õ²Ù×÷ËÄ¸ö»úÆ÷ÖÜÆÚ£¬¸øÓ²¼ş·´Ó¦Ê±¼ä
 303   1        E=0;            //µ±EÓÉ¸ßµçÆ½Ìø±ä³ÉµÍµçÆ½Ê±£¬Òº¾§Ä£¿é¿ªÊ¼Ö´ĞĞÃüÁî
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 6   

 304   1      }
 305          /*****************************************************
 306          º¯Êı¹¦ÄÜ£º¶ÔLCDµÄÏÔÊ¾Ä£Ê½½øĞĞ³õÊ¼»¯ÉèÖÃ
 307          ***************************************************/
 308          void LcdInitiate(void)
 309          {
 310   1          Delay_xMs(15);               //ÑÓÊ±15ms£¬Ê×´ÎĞ´Ö¸ÁîÊ±Ó¦¸øLCDÒ»¶Î½Ï³¤µÄ·´Ó¦Ê±¼ä
 311   1          WriteInstruction(0x38);     //ÏÔÊ¾Ä£Ê½ÉèÖÃ£º16¡Á2ÏÔÊ¾£¬5¡Á7µãÕó£¬8Î»Êı¾İ½Ó¿Ú
 312   1          Delay_xMs(5);                //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 313   1          WriteInstruction(0x38);
 314   1          Delay_xMs(5);               //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 315   1          WriteInstruction(0x38);     //Á¬ĞøÈı´Î£¬È·±£³õÊ¼»¯³É¹¦
 316   1          Delay_xMs(5);               //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 317   1          WriteInstruction(0x0c);     //ÏÔÊ¾Ä£Ê½ÉèÖÃ£ºÏÔÊ¾¿ª£¬ÎŞ¹â±ê£¬¹â±ê²»ÉÁË¸
 318   1          Delay_xMs(5);               //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 319   1          WriteInstruction(0x06);     //ÏÔÊ¾Ä£Ê½ÉèÖÃ£º¹â±êÓÒÒÆ£¬×Ö·û²»ÒÆ
 320   1          Delay_xMs(5);                //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 321   1          WriteInstruction(0x01);     //ÇåÆÁÄ»Ö¸Áî£¬½«ÒÔÇ°µÄÏÔÊ¾ÄÚÈİÇå³ı
 322   1          Delay_xMs(5);             //ÑÓÊ±5ms¡¡£¬¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 323   1       } 
 324          /************************************************************************
 325          ÒÔÏÂÊÇDS18B20µÄ²Ù×÷³ÌĞò
 326           ************************************************************************/ 
 327          sbit DQ=P2^2;
 328          unsigned char time;   //ÉèÖÃÈ«¾Ö±äÁ¿£¬×¨ÃÅÓÃÓÚÑÏ¸ñÑÓÊ±
 329          /*****************************************************
 330          º¯Êı¹¦ÄÜ£º½«DS18B20´«¸ĞÆ÷³õÊ¼»¯£¬¶ÁÈ¡Ó¦´ğĞÅºÅ
 331          ³ö¿Ú²ÎÊı£ºflag 
 332          ***************************************************/
 333          bit Init_DS18B20(void)  
 334          {
 335   1       bit flag;         //´¢´æDS18B20ÊÇ·ñ´æÔÚµÄ±êÖ¾£¬flag=0£¬±íÊ¾´æÔÚ£»flag=1£¬±íÊ¾²»´æÔÚ
 336   1       DQ = 1;           //ÏÈ½«Êı¾İÏßÀ­¸ß
 337   1       for(time=0;time<2;time++) //ÂÔÎ¢ÑÓÊ±Ô¼6Î¢Ãë
 338   1           ;
 339   1       DQ = 0;           //ÔÙ½«Êı¾İÏß´Ó¸ßÀ­µÍ£¬ÒªÇó±£³Ö480~960us
 340   1       for(time=0;time<200;time++)  //ÂÔÎ¢ÑÓÊ±Ô¼600Î¢Ãë
 341   1           ;         //ÒÔÏòDS18B20·¢³öÒ»³ÖĞø480~960usµÄµÍµçÆ½¸´Î»Âö³å 
 342   1       DQ = 1;           //ÊÍ·ÅÊı¾İÏß£¨½«Êı¾İÏßÀ­¸ß£© 
 343   1       for(time=0;time<10;time++)
 344   1           ;  //ÑÓÊ±Ô¼30us£¨ÊÍ·Å×ÜÏßºóĞèµÈ´ı15~60usÈÃDS18B20Êä³ö´æÔÚÂö³å£©
 345   1       flag=DQ;          //ÈÃµ¥Æ¬»ú¼ì²âÊÇ·ñÊä³öÁË´æÔÚÂö³å£¨DQ=0±íÊ¾´æÔÚ£©      
 346   1       for(time=0;time<200;time++)  //ÑÓÊ±×ã¹»³¤Ê±¼ä£¬µÈ´ı´æÔÚÂö³åÊä³öÍê±Ï
 347   1            ;
 348   1       return (flag);    //·µ»Ø¼ì²â³É¹¦±êÖ¾
 349   1      }
 350          /*****************************************************
 351          º¯Êı¹¦ÄÜ£º´ÓDS18B20¶ÁÈ¡Ò»¸ö×Ö½ÚÊı¾İ
 352          ³ö¿Ú²ÎÊı£ºdat
 353          ***************************************************/ 
 354          unsigned char ReadOneChar(void)
 355          {
 356   1        unsigned char i=0;  
 357   1        unsigned char dat;  //´¢´æ¶Á³öµÄÒ»¸ö×Ö½ÚÊı¾İ
 358   1        for (i=0;i<8;i++)
 359   1        {
 360   2          DQ =1;       // ÏÈ½«Êı¾İÏßÀ­¸ß
 361   2          _nop_();      //µÈ´ıÒ»¸ö»úÆ÷ÖÜÆÚ   
 362   2          DQ = 0;      //µ¥Æ¬»ú´ÓDS18B20¶ÁÊé¾İÊ±,½«Êı¾İÏß´Ó¸ßÀ­µÍ¼´Æô¶¯¶ÁÊ±Ğò
 363   2          dat>>=1;
 364   2          _nop_();     //µÈ´ıÒ»¸ö»úÆ÷ÖÜÆÚ      
 365   2          DQ = 1;     //½«Êı¾İÏß"ÈËÎª"À­¸ß,Îªµ¥Æ¬»ú¼ì²âDS18B20µÄÊä³öµçÆ½×÷×¼±¸
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 7   

 366   2          for(time=0;time<2;time++)
 367   2                   ;      //ÑÓÊ±Ô¼6us£¬Ê¹Ö÷»úÔÚ15usÄÚ²ÉÑù
 368   2          if(DQ==1)
 369   2            dat|=0x80;  //Èç¹û¶Áµ½µÄÊı¾İÊÇ1£¬Ôò½«1´æÈëdat
 370   2          else
 371   2            dat|=0x00;//Èç¹û¶Áµ½µÄÊı¾İÊÇ0£¬Ôò½«0´æÈëdat
 372   2               //½«µ¥Æ¬»ú¼ì²âµ½µÄµçÆ½ĞÅºÅDQ´æÈër[i] 
 373   2          for(time=0;time<8;time++)
 374   2                  ;              //ÑÓÊ±3us,Á½¸ö¶ÁÊ±ĞòÖ®¼ä±ØĞëÓĞ´óÓÚ1usµÄ»Ö¸´ÆÚ  
 375   2         }                      
 376   1         return (dat);    //·µ»Ø¶Á³öµÄÊ®½øÖÆÊı¾İ
 377   1      }
 378          /*****************************************************
 379          º¯Êı¹¦ÄÜ£ºÏòDS18B20Ğ´ÈëÒ»¸ö×Ö½ÚÊı¾İ
 380          Èë¿Ú²ÎÊı£ºdat
 381          ***************************************************/  
 382          WriteOneChar(unsigned char dat)
 383          {
 384   1        unsigned char i=0;
 385   1        for (i=0; i<8; i++)
 386   1        {
 387   2          DQ =1;         // ÏÈ½«Êı¾İÏßÀ­¸ß
 388   2          _nop_();       //µÈ´ıÒ»¸ö»úÆ÷ÖÜÆÚ  
 389   2          DQ=0;          //½«Êı¾İÏß´Ó¸ßÀ­µÍÊ±¼´Æô¶¯Ğ´Ê±Ğò       
 390   2          DQ=dat&0x01;   //ÀûÓÃÓëÔËËãÈ¡³öÒªĞ´µÄÄ³Î»¶ş½øÖÆÊı¾İ,
 391   2                             //²¢½«ÆäËÍµ½Êı¾İÏßÉÏµÈ´ıDS18B20²ÉÑù  
 392   2          for(time=0;time<10;time++)  
 393   2               ;//ÑÓÊ±Ô¼30us£¬DS18B20ÔÚÀ­µÍºóµÄÔ¼15~60usÆÚ¼ä´ÓÊı¾İÏßÉÏ²ÉÑù
 394   2          DQ=1;          //ÊÍ·ÅÊı¾İÏß       
 395   2          for(time=0;time<1;time++)
 396   2              ;//ÑÓÊ±3us,Á½¸öĞ´Ê±Ğò¼äÖÁÉÙĞèÒª1usµÄ»Ö¸´ÆÚ
 397   2          dat>>=1;       //½«datÖĞµÄ¸÷¶ş½øÖÆÎ»Êı¾İÓÒÒÆ1Î»
 398   2        }
 399   1        for(time=0;time<4;time++)
 400   1                      ; //ÉÔ×÷ÑÓÊ±,¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 401   1      }
 402          /******************************************************************************
 403          ÒÔÏÂÊÇÓëÎÂ¶ÈÓĞ¹ØµÄÏÔÊ¾ÉèÖÃ
 404           ******************************************************************************/
 405           /*****************************************************
 406          º¯Êı¹¦ÄÜ£ºÏÔÊ¾Ã»ÓĞ¼ì²âµ½DS18B20
 407          ***************************************************/   
 408          void display_error(void)
 409          {
 410   1        unsigned char i;
 411   1        WriteAddress(0x00);    //Ğ´ÏÔÊ¾µØÖ·£¬½«ÔÚµÚ1ĞĞµÚ1ÁĞ¿ªÊ¼ÏÔÊ¾
 412   1        i = 0;                //´ÓµÚÒ»¸ö×Ö·û¿ªÊ¼ÏÔÊ¾
 413   1        while(Error[i] != '\0')  //Ö»ÒªÃ»ÓĞĞ´µ½½áÊø±êÖ¾£¬¾Í¼ÌĞøĞ´
 414   1          {
 415   2            WriteData(Error[i]);   //½«×Ö·û³£Á¿Ğ´ÈëLCD
 416   2            i++;                 //Ö¸ÏòÏÂÒ»¸ö×Ö·û
 417   2            Delay_xMs(100);//ÑÓÊ±100ms½Ï³¤Ê±¼ä£¬ÒÔ¿´Çå¹ØÓÚÏÔÊ¾µÄËµÃ÷
 418   2          } 
 419   1        while(1)              //½øÈëËÀÑ­»·£¬µÈ´ı²éÃ÷Ô­Òò
 420   1                ;
 421   1      }
 422          /*****************************************************
 423          º¯Êı¹¦ÄÜ£ºÏÔÊ¾ÎÂ¶È·ûºÅ
 424          ***************************************************/   
 425          void display_symbol(void)
 426          {
 427   1        unsigned char i;
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 8   

 428   1        WriteAddress(0x00);    //Ğ´ÏÔÊ¾µØÖ·£¬½«ÔÚµÚ2ĞĞµÚ1ÁĞ¿ªÊ¼ÏÔÊ¾
 429   1        i = 0;                //´ÓµÚÒ»¸ö×Ö·û¿ªÊ¼ÏÔÊ¾
 430   1        while(Temp[i] != '\0')  //Ö»ÒªÃ»ÓĞĞ´µ½½áÊø±êÖ¾£¬¾Í¼ÌĞøĞ´
 431   1          {
 432   2            WriteData(Temp[i]);   //½«×Ö·û³£Á¿Ğ´ÈëLCD
 433   2            i++;                 //Ö¸ÏòÏÂÒ»¸ö×Ö·û
 434   2            Delay_xMs(50);        //ÑÓÊ±1ms¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 435   2          } 
 436   1      }
 437          
 438          /*****************************************************
 439          º¯Êı¹¦ÄÜ£ºÏÔÊ¾ÎÂ¶ÈµÄĞ¡Êıµã
 440          ***************************************************/   
 441          void  display_dot(void)
 442          {
 443   1        WriteAddress(0x09);   //Ğ´ÏÔÊ¾µØÖ·£¬½«ÔÚµÚ2ĞĞµÚ10ÁĞ¿ªÊ¼ÏÔÊ¾      
 444   1        WriteData('.');      //½«Ğ¡ÊıµãµÄ×Ö·û³£Á¿Ğ´ÈëLCD
 445   1        Delay_xMs(50);         //ÑÓÊ±1ms¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä    
 446   1      }
 447          /*****************************************************
 448          º¯Êı¹¦ÄÜ£ºÏÔÊ¾ÎÂ¶ÈµÄµ¥Î»(Cent)
 449          ***************************************************/   
 450          void  display_cent(void)
 451          {
 452   1        unsigned char i;    
 453   1        WriteAddress(0x0c);        //Ğ´ÏÔÊ¾µØÖ·£¬½«ÔÚµÚ2ĞĞµÚ13ÁĞ¿ªÊ¼ÏÔÊ¾  
 454   1        i = 0;                    //´ÓµÚÒ»¸ö×Ö·û¿ªÊ¼ÏÔÊ¾ 
 455   1        while(Cent[i] != '\0')     //Ö»ÒªÃ»ÓĞĞ´µ½½áÊø±êÖ¾£¬¾Í¼ÌĞøĞ´
 456   1          {
 457   2            WriteData(Cent[i]);     //½«×Ö·û³£Á¿Ğ´ÈëLCD
 458   2            i++;                 //Ö¸ÏòÏÂÒ»¸ö×Ö·û
 459   2            Delay_xMs(50);        //ÑÓÊ±1ms¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 460   2          } 
 461   1      }
 462          /*****************************************************
 463          º¯Êı¹¦ÄÜ£ºÏÔÊ¾ÎÂ¶ÈµÄÕûÊı²¿·Ö
 464          Èë¿Ú²ÎÊı£ºx
 465          ***************************************************/ 
 466          void display_temp1(unsigned char x)
 467          {
 468   1        unsigned char j,k,l;     //j,k,l·Ö±ğ´¢´æÎÂ¶ÈµÄ°ÙÎ»¡¢Ê®Î»ºÍ¸öÎ»
 469   1        j=x/100;              //È¡°ÙÎ»
 470   1        k=(x%100)/10;    //È¡Ê®Î»
 471   1        l=x%10;             //È¡¸öÎ»  
 472   1        WriteAddress(0x06);    //Ğ´ÏÔÊ¾µØÖ·,½«ÔÚµÚ2ĞĞµÚ7ÁĞ¿ªÊ¼ÏÔÊ¾
 473   1        WriteData(digit[j]);    //½«°ÙÎ»Êı×ÖµÄ×Ö·û³£Á¿Ğ´ÈëLCD
 474   1        WriteData(digit[k]);    //½«Ê®Î»Êı×ÖµÄ×Ö·û³£Á¿Ğ´ÈëLCD
 475   1        WriteData(digit[l]);    //½«¸öÎ»Êı×ÖµÄ×Ö·û³£Á¿Ğ´ÈëLCD
 476   1        Delay_xMs(50);         //ÑÓÊ±1ms¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä     
 477   1       }
 478           /*****************************************************
 479          º¯Êı¹¦ÄÜ£ºÏÔÊ¾ÎÂ¶ÈµÄĞ¡ÊıÊı²¿·Ö
 480          Èë¿Ú²ÎÊı£ºx
 481          ***************************************************/ 
 482           void display_temp2(unsigned char x)
 483          {
 484   1        WriteAddress(0x0a);      //Ğ´ÏÔÊ¾µØÖ·,½«ÔÚµÚ2ĞĞµÚ11ÁĞ¿ªÊ¼ÏÔÊ¾
 485   1        WriteData(digit[x]);     //½«Ğ¡Êı²¿·ÖµÄµÚÒ»Î»Êı×Ö×Ö·û³£Á¿Ğ´ÈëLCD
 486   1        Delay_xMs(50);          //ÑÓÊ±1ms¸øÓ²¼şÒ»µã·´Ó¦Ê±¼ä
 487   1      }
 488          /*****************************************************
 489          º¯Êı¹¦ÄÜ£º×öºÃ¶ÁÎÂ¶ÈµÄ×¼±¸
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 9   

 490          ***************************************************/ 
 491          void ReadyReadTemp(void)
 492          {
 493   1        Init_DS18B20();     //½«DS18B20³õÊ¼»¯
 494   1        WriteOneChar(0xCC); // Ìø¹ı¶ÁĞòºÅÁĞºÅµÄ²Ù×÷
 495   1        WriteOneChar(0x44); // Æô¶¯ÎÂ¶È×ª»»   
 496   1        for(time=0;time<100;time++);   //ÎÂ¶È×ª»»ĞèÒªÒ»µãÊ±¼ä
 497   1        Init_DS18B20();     //½«DS18B20³õÊ¼»¯
 498   1        WriteOneChar(0xCC); //Ìø¹ı¶ÁĞòºÅÁĞºÅµÄ²Ù×÷
 499   1        WriteOneChar(0xBE); //¶ÁÈ¡ÎÂ¶È¼Ä´æÆ÷,Ç°Á½¸ö·Ö±ğÊÇÎÂ¶ÈµÄµÍÎ»ºÍ¸ßÎ» 
 500   1      }
 501          
 502          /******************************************************************************/
 503          /* º¯ÊıÃû³Æ  : main                                                           */
 504          /* º¯ÊıÃèÊö  : Ö÷º¯Êı                                                         */
 505          /* ÊäÈë²ÎÊı  : ÎŞ                                                             */
 506          /* ²ÎÊıÃèÊö  : ÎŞ                                                             */
 507          /* ·µ»ØÖµ    : ÎŞ                                                             */
 508          /******************************************************************************/          
 509          void main(void)
 510          {
 511   1        unsigned char TL;     //´¢´æÔİ´æÆ÷µÄÎÂ¶ÈµÍÎ»
 512   1        unsigned char TH;    //´¢´æÔİ´æÆ÷µÄÎÂ¶È¸ßÎ»
 513   1        unsigned char TN;      //´¢´æÎÂ¶ÈµÄÕûÊı²¿·Ö
 514   1        unsigned char TD;       //´¢´æÎÂ¶ÈµÄĞ¡Êı²¿·Ö
 515   1        int fflag;
 516   1        VELOCITY=3453;       //23ÉãÊÏ¶ÈÊ±µÄÉùËÙ£¬ÉùËÙV= 331.5 + 0.6*ÎÂ¶È£»
 517   1        RW = 0;
 518   1        initLCD();
 519   1        Init_MCU();
 520   1        Init_Parameter();
 521   1        Alarm(2);
 522   1        display_char(table,0x00);
 523   1        display_char(table0,0x40);
 524   1        Delay_xMs(30000);
 525   1        display_char(table2,0x00);
 526   1        display_char(table1,0x40);
 527   1        if(Init_DS18B20()==1)
 528   1          display_error();
 529   1        display_symbol();    //ÏÔÊ¾ÎÂ¶ÈËµÃ÷
 530   1        display_dot();       //ÏÔÊ¾ÎÂ¶ÈµÄĞ¡Êıµã
 531   1        display_cent();      //ÏÔÊ¾ÎÂ¶ÈµÄµ¥Î»
 532   1        while(1)
 533   1        {
 534   2           Trig_SuperSonic(8);         //´¥·¢³¬Éù²¨·¢Éä
 535   2      //     while(INPUT == 0)          //µÈ´ı»ØÉù
 536   2      //         {
 537   2      //             ;
 538   2      //         }
 539   2           ReadyReadTemp();     //¶ÁÎÂ¶È×¼±¸
 540   2           TL=ReadOneChar();    //ÏÈ¶ÁµÄÊÇÎÂ¶ÈÖµµÍÎ»
 541   2           TH=ReadOneChar();    //½Ó×Å¶ÁµÄÊÇÎÂ¶ÈÖµ¸ßÎ»
 542   2           TN=TH*16+TL/16;      //Êµ¼ÊÎÂ¶ÈÖµ=(TH*256+TL)/16,¼´£ºTH*16+TL/16
 543   2                              //ÕâÑùµÃ³öµÄÊÇÎÂ¶ÈµÄÕûÊı²¿·Ö,Ğ¡Êı²¿·Ö±»¶ªÆúÁË
 544   2           VELOCITY=3315+6*TN;// 331.5 + 0.6*ÎÂ¶È£»
 545   2           fflag=Measure_Distance();        //¼ÆËãÂö¿í²¢×ª»»Îª¾àÀë
 546   2      //     ReadyReadTemp();     //¶ÁÎÂ¶È×¼±¸
 547   2      //     TL=ReadOneChar();    //ÏÈ¶ÁµÄÊÇÎÂ¶ÈÖµµÍÎ»
 548   2      //     TH=ReadOneChar();    //½Ó×Å¶ÁµÄÊÇÎÂ¶ÈÖµ¸ßÎ»
 549   2      //     TN=TH*16+TL/16;      //Êµ¼ÊÎÂ¶ÈÖµ=(TH*256+TL)/16,¼´£ºTH*16+TL/16
 550   2                              //ÕâÑùµÃ³öµÄÊÇÎÂ¶ÈµÄÕûÊı²¿·Ö,Ğ¡Êı²¿·Ö±»¶ªÆúÁË
 551   2           TD=(TL%16)*10/16;    //¼ÆËãÎÂ¶ÈµÄĞ¡Êı²¿·Ö,½«ÓàÊı³ËÒÔ10ÔÙ³ıÒÔ16È¡Õû£¬
C51 COMPILER V9.54   ULTRASONIC                                                            07/03/2017 19:47:27 PAGE 10  

 552   2                              //ÕâÑùµÃµ½µÄÊÇÎÂ¶ÈĞ¡Êı²¿·ÖµÄµÚÒ»Î»Êı×Ö(±£Áô1Î»Ğ¡Êı)
 553   2           display_temp1(TN);    //ÏÔÊ¾ÎÂ¶ÈµÄÕûÊı²¿·Ö
 554   2           display_temp2(TD);    //ÏÔÊ¾ÎÂ¶ÈµÄĞ¡Êı²¿·Ö
 555   2           display_char(table3,0x40);
 556   2           if(fflag){
 557   3           display(distance,0x49);    //ÏÔÊ¾¾àÀë
 558   3           }
 559   2           Init_Parameter();          // ²ÎÊıÖØĞÂ³õÊ¼»¯
 560   2           delayt(100);               //ÑÓÊ±£¬Á½´Î·¢ÉäÖ®¼äÒªÖÁÉÙÓĞ10ms¼ä¸ô
 561   2         }  
 562   1      }
 563          /******************************************************************************/
 564          /* º¯ÊıÃû³Æ  : timer0                                                         */
 565          /* º¯ÊıÃèÊö  : T0ÖĞ¶Ï´¦Àíº¯Êı                                                 */
 566          /* ÊäÈë²ÎÊı  : ÎŞ                                                             */
 567          /* ²ÎÊıÃèÊö  : ÎŞ                                                             */
 568          /* ·µ»ØÖµ    : ÎŞ                                                             */
 569          /******************************************************************************/
 570          void timer0 (void) interrupt 1
 571          {
 572   1        TF0 = 0;
 573   1        TL0 = 0x66;
 574   1        TH0 = 0xfc;
 575   1        count++;
 576   1        if(count == 18)//³¬Éù²¨»ØÉùÂö¿í×î¶à18ms
 577   1        {
 578   2          TR0 =0;
 579   2          TL0 = 0x66;
 580   2          TH0 = 0xfc;
 581   2          count = 0;
 582   2        }
 583   1      }
 584          /******************************************************************************/
*** WARNING C290 IN LINE 401 OF UltraSonic.c: missing return value


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1333    ----
   CONSTANT SIZE    =     50    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     90      11
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  1 WARNING(S),  0 ERROR(S)
